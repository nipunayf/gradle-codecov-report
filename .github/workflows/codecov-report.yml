name: Codecov Report

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write

jobs:
  coverage-report:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for accurate coverage comparison

      - name: Set up JDK 11
        uses: actions/setup-java@v4
        with:
          java-version: '11'
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Run tests with coverage
        run: ./gradlew testCoverage --no-daemon
        continue-on-error: true

      - name: Upload test results to Codecov
        if: ${{ !cancelled() }}
        uses: codecov/test-results-action@v1
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          flags: unittests
          name: codecov-test-results
          verbose: true

      - name: Upload coverage to Codecov
        if: ${{ !cancelled() }}
        uses: codecov/codecov-action@v4
        with:
          directory: ./build/reports/jacoco/test/
          files: jacocoTestReport.xml
          flags: unittests
          name: codecov-coverage
          fail_ci_if_error: true
          verbose: true
          token: ${{ secrets.CODECOV_TOKEN }}

      - name: Check for uncovered lines
        if: ${{ !cancelled() }}
        run: |
          echo "=== Checking for uncovered lines ==="
          # Check if any module has less than 100% coverage
          for module in extract transform load runner; do
            if [ -f "${module}/build/reports/jacoco/test/jacocoTestReport.xml" ]; then
              echo "Checking ${module} module coverage..."
              # Parse XML to get coverage percentage (simplified check)
              COVERAGE=$(grep -o 'line-rate="[^"]*"' "${module}/build/reports/jacoco/test/jacocoTestReport.xml" | head -1 | cut -d'"' -f2)
              COVERAGE_PCT=$(echo "$COVERAGE * 100" | bc -l 2>/dev/null || echo "0")
              echo "${module} coverage: ${COVERAGE_PCT}%"
              
              # Fail if coverage is less than 100%
              if (( $(echo "$COVERAGE_PCT < 100" | bc -l) )); then
                echo "âŒ ${module} has less than 100% coverage (${COVERAGE_PCT}%)"
                exit 1
              else
                echo "âœ… ${module} has 100% coverage"
              fi
            fi
          done

      - name: Generate test and coverage summary
        if: always()
        run: |
          echo "=== Test Results Summary ==="
          if [ -d "extract/build/test-results/test" ] || [ -d "transform/build/test-results/test" ] || [ -d "load/build/test-results/test" ] || [ -d "runner/build/test-results/test" ]; then
            echo "âœ… Test results generated successfully"
            echo "ðŸ“‹ Test result locations:"
            for module in extract transform load runner; do
              if [ -d "${module}/build/test-results/test" ]; then
                echo "   - ${module}/build/test-results/test/"
              fi
            done
          else
            echo "âš ï¸ No test results found"
          fi

          echo ""
          echo "=== Coverage Report Summary ==="
          if [ -f "build/reports/jacoco/test/jacocoTestReport.xml" ]; then
            echo "âœ… Coverage report generated successfully"
            echo "ðŸ“Š Report location: build/reports/jacoco/test/html/index.html"
          else
            echo "âš ï¸ Coverage report not found"
          fi
