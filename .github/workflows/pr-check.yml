name: PR Coverage Check

on:
  pull_request:
    branches:
      - main
      - develop

permissions:
  contents: read
  pull-requests: write

jobs:
  test-and-coverage:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for accurate coverage comparison
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Set up JDK 11
        uses: actions/setup-java@v4
        with:
          java-version: '11'
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4
        with:
          cache-read-only: true

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Fetch base branch for comparison
        run: |
          git fetch origin ${{ github.base_ref }} --depth=1
          echo "Base branch: ${{ github.base_ref }}"
          git log --oneline -5

      - name: Run tests with coverage
        run: ./gradlew testCoverage --no-daemon
        continue-on-error: true

      - name: Upload test results to Codecov
        if: ${{ !cancelled() }}
        uses: codecov/test-results-action@v1
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          flags: unittests
          name: codecov-test-results
          verbose: true

      - name: Upload coverage to Codecov
        if: ${{ !cancelled() }}
        uses: codecov/codecov-action@v4
        with:
          files: ./build/reports/jacoco/test/jacocoTestReport.xml
          flags: unittests
          name: codecov-coverage
          fail_ci_if_error: false
          verbose: true
          token: ${{ secrets.CODECOV_TOKEN }}

      - name: Upload test results to Codecov
        if: ${{ !cancelled() }}
        uses: codecov/test-results-action@v1
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          flags: unittests
          name: codecov-test-results
          verbose: true

      - name: Debug coverage files
        if: ${{ !cancelled() }}
        run: |
          echo "=== Coverage Files Debug ==="
          find . -name "jacocoTestReport.xml" -type f
          echo ""
          echo "Root report content preview:"
          if [ -f "build/reports/jacoco/test/jacocoTestReport.xml" ]; then
            head -20 build/reports/jacoco/test/jacocoTestReport.xml
          else
            echo "Root report not found"
          fi

      - name: Upload coverage to Codecov
        if: ${{ !cancelled() }}
        uses: codecov/codecov-action@v4
        with:
          directory: ./build/reports/jacoco/test/
          files: jacocoTestReport.xml
          flags: unittests
          name: codecov-coverage
          fail_ci_if_error: false
          verbose: true
          token: ${{ secrets.CODECOV_TOKEN }}

      - name: Generate test and coverage summary
        if: always()
        run: |
          echo "=== Test Results Summary ==="
          if [ -d "extract/build/test-results/test" ] || [ -d "transform/build/test-results/test" ] || [ -d "load/build/test-results/test" ] || [ -d "runner/build/test-results/test" ]; then
            echo "‚úÖ Test results generated successfully"
            echo "üìã Test result locations:"
            for module in extract transform load runner; do
              if [ -d "${module}/build/test-results/test" ]; then
                echo "   - ${module}/build/test-results/test/"
              fi
            done
          else
            echo "‚ö†Ô∏è No test results found"
          fi

          echo ""
          echo "=== Coverage Report Summary ==="
          if [ -f "build/reports/jacoco/test/jacocoTestReport.xml" ]; then
            echo "‚úÖ Coverage report generated successfully"
            echo "üìä Report location: build/reports/jacoco/test/html/index.html"
          else
            echo "‚ö†Ô∏è Coverage report not found"
          fi
